<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulador 3D – Robô terrestre com LiDAR 3D</title>
  <meta name="theme-color" content="#0b1020">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-192.png">
  <style>
    :root { --bg:#0b1020; --line:#1e2a4a; --text:#e9f1ff; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { padding:10px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; background:rgba(11,16,32,.9); border-bottom:1px solid var(--line); position:sticky; top:0; z-index:10 }
    h1 { font-size:16px; margin:0; font-weight:600 }
    #controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    label { font-size:12px; opacity:.9 }
    input[type=range]{ width:120px }
    button, select { background:#101a38; color:var(--text); border:1px solid #2a3b6a; border-radius:8px; padding:6px 10px; }
    #wrap { display:grid; grid-template-columns: 260px 1fr; height: calc(100vh - 52px); }
    #sidebar { padding:10px; border-right:1px solid var(--line); font-size:14px; overflow:auto }
    #view { position:relative; height:100%; }
    #three { display:block; width:100%; height:100%; }
    .hud { position:absolute; left:12px; bottom:12px; display:flex; gap:6px; flex-wrap:wrap; font-size:12px; }
    .pill { background:#0d172f; border:1px solid #263a6a; padding:2px 6px; border-radius:12px; }
    #error { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.7); color:#fff; text-align:center; padding:20px; }
    @media(max-width:900px){ #wrap{grid-template-columns:1fr;} #sidebar{border-right:none; border-top:1px solid var(--line);} #view{height:55vh;} }
  </style>
</head>
<body>
  <header>
    <h1>Robô terrestre • LiDAR 3D</h1>
    <div id="controls">
      <label>Azimutes <input id="az" type="range" min="24" max="96" step="8" value="48"></label>
      <label>Elevações <input id="el" type="range" min="8" max="24" step="2" value="12"></label>
      <label>Alcance <input id="rng" type="range" min="10" max="60" step="1" value="30"></label>
      <label>Ruído <input id="noise" type="range" min="0" max="10" step="1" value="2"></label>
      <select id="layout"><option value="linhas">Linhas</option><option value="grade">Grade</option><option value="aleatorio">Aleatório</option></select>
      <button id="reset">Reset</button>
      <button id="export">CSV</button>
    </div>
  </header>
  <div id="wrap">
    <aside id="sidebar">
      <p><b>Como usar:</b></p>
      <ul><li>Clique no chão para definir <em>goal</em>.</li><li>WASD/setas movem; Shift acelera.</li><li>Mouse orbita/zoom.</li></ul>
    </aside>
    <main id="view">
      <canvas id="three"></canvas>
      <div class="hud"><span class="pill">Robô azul</span><span class="pill">LiDAR branco</span><span class="pill">Obstáculos verdes</span></div>
    </main>
  </div>
  <div id="error"></div>

  <script>
    // Dynamic loader with multiple CDNs
    function addScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=()=>rej(new Error('fail '+src));document.head.appendChild(s);});}
    async function loadThree(){
      const tries=[
        'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js',
        'https://unpkg.com/three@0.160.0/build/three.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js'
      ];
      let ok=false, lastErr=null;
      for(const url of tries){ try{ await addScript(url); if(window.THREE){ ok=true; break; } } catch(e){ lastErr=e; } }
      if(!ok) throw lastErr||new Error('THREE falhou');
      // OrbitControls (global)
      const ctrlTries=[
        'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js',
        'https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js'
      ];
      for(const url of ctrlTries){ try{ await addScript(url); if(THREE.OrbitControls) break; } catch(e){} }
      return window.THREE;
    }

    function showError(msg){
      const div=document.getElementById('error'); div.style.display='flex';
      div.innerHTML='<div><h2>Falha ao carregar biblioteca 3D</h2><p>'+msg+'</p><p>Tente recarregar a página (Ctrl+F5). Se persistir, a rede pode estar bloqueando CDNs.</p></div>';
    }

    (async ()=>{
      try { await loadThree(); } catch(e){ showError(e.message); return; }

      const canvas=document.getElementById('three');
      const renderer=new THREE.WebGLRenderer({canvas,antialias:true});renderer.setPixelRatio(Math.min(2,window.devicePixelRatio||1));
      const scene=new THREE.Scene();scene.background=new THREE.Color(0x0b1020);
      const camera=new THREE.PerspectiveCamera(60,1,0.1,200);camera.position.set(12,14,18);
      const controls = THREE.OrbitControls ? new THREE.OrbitControls(camera, renderer.domElement) : null; if(controls) controls.target.set(0,0,0);

      const dlight=new THREE.DirectionalLight(0xffffff,1);dlight.position.set(10,20,10);scene.add(dlight);scene.add(new THREE.AmbientLight(0xffffff,0.3));
      const ground=new THREE.Mesh(new THREE.PlaneGeometry(100,100),new THREE.MeshPhongMaterial({color:0x0d1328,side:THREE.DoubleSide}));ground.rotation.x=-Math.PI/2;scene.add(ground);
      const robot=new THREE.Mesh(new THREE.CylinderGeometry(0.6,0.6,0.4,24),new THREE.MeshPhongMaterial({color:0x59b4ff}));robot.position.set(-12,0.2,0);scene.add(robot);
      const robotDir=new THREE.ArrowHelper(new THREE.Vector3(1,0,0),robot.position,1.2,0xc7e0ff);scene.add(robotDir);
      const flag=new THREE.Mesh(new THREE.ConeGeometry(0.2,0.6,12),new THREE.MeshPhongMaterial({color:0xf0d24d}));flag.position.set(10,0.3,0);scene.add(flag);

      const obstacles=[];const matObs=new THREE.MeshPhongMaterial({color:0x0f5a2a});
      function clearObs(){for(const o of obstacles)scene.remove(o);obstacles.length=0;}
      function addBox(x,y,z,sx,sy,sz){const m=new THREE.Mesh(new THREE.BoxGeometry(sx,sy,sz),matObs);m.position.set(x,y,z);scene.add(m);obstacles.push(m);}
      function layoutLinhas(){clearObs();for(let z=-12;z<=12;z+=2.2){if((z+12)/2.2%4===3)continue;for(let x=-18;x<=18;x+=2.4){addBox(x,0.35,z,1.4,0.7,0.8);}}}
      function layoutGrade(){clearObs();for(let x=-18;x<=18;x+=3){for(let z=-12;z<=12;z+=3){if((x+z)%6===0)continue;addBox(x,0.5,z,1.4,1,1.4);}}}
      function layoutAleatorio(){clearObs();for(let i=0;i<60;i++){addBox(-18+Math.random()*36,0.5,-12+Math.random()*24,1+Math.random()*2,1,1+Math.random()*2);}}
      function setLayout(k){if(k==='linhas')layoutLinhas();else if(k==='grade')layoutGrade();else layoutAleatorio();} setLayout('linhas');

      const raycaster=new THREE.Raycaster();const mouse=new THREE.Vector2();
      renderer.domElement.addEventListener('pointerdown',e=>{const r=renderer.domElement.getBoundingClientRect();mouse.x=(e.clientX-r.left)/r.width*2-1;mouse.y=-(e.clientY-r.top)/r.height*2+1;raycaster.setFromCamera(mouse,camera);const hit=raycaster.intersectObject(ground)[0];if(hit){flag.position.copy(hit.point).setY(0.3);}});
      const ptsGeom=new THREE.BufferGeometry(),ptsMat=new THREE.PointsMaterial({color:0xffffff,size:0.03});const pts=new THREE.Points(ptsGeom,ptsMat);scene.add(pts);

      function sampleLidar(az,el,range,noise){const arr=[];const origin=robot.position.clone();origin.y+=0.4;const rotY=robot.rotation.y;
        for(let i=0;i<az;i++){const azm=-Math.PI+i*2*Math.PI/az;for(let j=0;j<el;j++){const ele=-Math.PI/6+j*(Math.PI/3)/(el-1);
          let dx=Math.cos(ele)*Math.cos(azm),dy=Math.sin(ele),dz=Math.cos(ele)*Math.sin(azm);
          const rdx=dx*Math.cos(rotY)+dz*Math.sin(rotY),rdz=-dx*Math.sin(rotY)+dz*Math.cos(rotY);
          const dir=new THREE.Vector3(rdx,dy,rdz).normalize();raycaster.set(origin,dir);raycaster.far=range;
          const hit=raycaster.intersectObjects([ground,...obstacles])[0];let p=hit?hit.point.clone():origin.clone().add(dir.multiplyScalar(range));
          if(noise){p.x+=(Math.random()*2-1)*range*noise*0.003;p.y+=(Math.random()*2-1)*range*noise*0.003;p.z+=(Math.random()*2-1)*range*noise*0.003;}
          arr.push(p.x,p.y,p.z);}}ptsGeom.setAttribute('position',new THREE.BufferAttribute(new Float32Array(arr),3));ptsGeom.attributes.position.needsUpdate=true;}

      const keys=new Set();window.addEventListener('keydown',e=>keys.add(e.key));window.addEventListener('keyup',e=>keys.delete(e.key));
      let v=0,w=0;const vmax=2,wmax=1.8,accel=3;
      function step(dt){let yaw=robot.rotation.y;let vCmd=(keys.has('w')||keys.has('ArrowUp'))?1:(keys.has('s')||keys.has('ArrowDown'))?-1:1;let wCmd=(keys.has('a')||keys.has('ArrowLeft'))?1:(keys.has('d')||keys.has('ArrowRight'))?-1:0;
        v+=Math.max(-accel*dt,Math.min(accel*dt,vCmd*vmax-v));w+=Math.max(-accel*dt,Math.min(accel*dt,wCmd*wmax-w));yaw+=w*dt;robot.rotation.y=yaw;
        robot.position.add(new THREE.Vector3(Math.cos(yaw),0,Math.sin(yaw)).multiplyScalar(v*dt));robotDir.position.copy(robot.position);robotDir.setDirection(new THREE.Vector3(Math.cos(yaw),0,Math.sin(yaw)));
        sampleLidar(document.getElementById('az').value,document.getElementById('el').value,document.getElementById('rng').value,document.getElementById('noise').value/100);}

      function resize(){const el=document.getElementById('view');const w=el.clientWidth;const h=el.clientHeight||Math.round(window.innerHeight*0.6);renderer.setSize(w,h,false);camera.aspect=w/h;camera.updateProjectionMatrix();}
      window.addEventListener('resize',resize); resize();

      document.getElementById('reset').onclick=()=>{robot.position.set(-12,0.2,0);robot.rotation.y=0;};
      document.getElementById('export').onclick=()=>{ /* placeholder: telemetry export could be added */ alert('CSV: em breve'); };

      let last=performance.now();function animate(){const now=performance.now();const dt=Math.min(0.033,(now-last)/1000);last=now;step(dt);if(controls)controls.update();renderer.render(scene,camera);requestAnimationFrame(animate);} animate();
    })();
  </script>
</body>
</html>
